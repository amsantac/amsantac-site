---
layout: post
title:  "Integrating QGIS and R: A stratified sampling example"
date:   2015-10-31 11:02:52
categories: blog en
tags: R QGIS sampling
image: 2015-10-03-qgis-r-mini.jpg
published: false
---

A common step in land cover mapping and multitemporal analysis of land cover change based on remotely-sensed data is the conversion of the data registered in each pixel of land cover by the satellite sensor into surface reflectance values that can be used for mapping. This process is known as calibration to surface reflectance and involves radiometric calibration and atmospheric correction. 

As mentioned in [my previous post], these steps can be conducted using the [CLASlite software]. In this post I explain how to automate the creation of the text files required by CLASlite for image calibration through batch processing.

<!--more-->

<img src="/images/2015-10-31-qgis-r-fig-1.jpg" alt="" title="" style="width:800px">

### Set up R scripts in QGIS

First we have to activate R in QGIS and indicate where the R binaries are located. In QGIS, go to the Processing - Options... menu. In the 'Processing options' window, go to 'R scripts' and mark the checkbox next to 'Activate'. In the 'R folder' option, browse and select the folder where R is installed in your computer. Also, note the 'R Scripts folder'; this is the folder where your R scripts will be saved. Click OK to close the window.

<img src="/images/2015-10-31-qgis-r-fig-1.jpg" alt="" title="Setting up R in QGIS" >

Now open the Processing Toolbox by clicking 'Toolbox' in the 'Processing' menu in QGIS. You should see the 'Processing Toolbox' panel open on the right of QGIS interface. Notice the dropdown menu at the bottom of the Processing Toolbox indicating that you are seeing the 'Simplified interface'. Switch to the "Advanced interface".

<img src="/images/2015-10-31-qgis-r-fig-2.jpg" alt="" title="Processing Toolbox - Advanced interface" >

### How to run an R script in QGIS

In the next example I am going to show how to sample point locations within a polygons shapefile following a stratified random sampling, where the sampling size is taken from a table that indicates the number of points to be created for each category of a given land cover type. The following screenshot shows the land cover map and the table loaded in QGIS using the Browser panel:

<img src="/images/2015-10-31-qgis-r-fig-3.jpg" alt="" title="Loaded layers" style="width:800px">

For this tutorial we need the 'sp' package. If this package is not installed in your R environment yet, please see [in this previous post] how to install it.

Now let's create an R script in QGIS. In the Processing Toolbox, go to 'R scripts' - 'Tools' and click "Create new R script". A new 'Script editor' window must open.

Copy and paste the following code:

```
##polyg=vector
##polyg_cover_id=field polyg
##sizes_table=table
##table_cover_id=field sizes_table
##sampling_size=field sizes_table
##output=output vector
library(sp)

i <- 1
cover <- unique(polyg[[polyg_cover_id]])[i]
covermap <- polyg[polyg[[polyg_cover_id]] == cover,]
n <- sizes_table[which(sizes_table[[table_cover_id]] == cover), sampling_size]
spdf1 <- SpatialPointsDataFrame(spsample(covermap, n, "random"), data = data.frame(cover = rep(cover, n)))

for (i in 2:length(unique(polyg[[polyg_cover_id]]))){
  cover <- unique(polyg[[polyg_cover_id]])[i]
  covermap <- polyg[polyg[[polyg_cover_id]] == cover,]
  n <- sizes_table[which(sizes_table[[table_cover_id]] == cover), sampling_size]
  spdf1 <- rbind(spdf1, 
                 SpatialPointsDataFrame(spsample(covermap, n, "random"), data = data.frame(cover = rep(cover, n)))
  )
}

output = spdf1
```

<img src="/images/2015-10-31-qgis-r-fig-4.jpg" alt="" title="Create an R script" style="width:800px">

The first six lines, which start with a double pound sign (##), indicate QGIS the inputs and the outputs of the algorithm and are used to create the user interface. This information is also used to create the corresponding R variables that can be used later as input for R commands. For instance, we are telling QGIS we are defining an input called 'polyg' of type 'vector' and another input called 'sizes_table' of type 'table' (in the first and third lines, respectively). 'polyg_cover_id' and 'table_cover_id' are fields from the vector map and the table, respectively, which are the primary key (aka key field) that will be used to match the two tables. For this example, this key field represents a unique identifier for each land cover type. After defining the inputs, the 'sp' package is loaded, the sample point locations are created for the first land cover type, and then the sampling points for the second to the last land cover type are created and merged to the previously created set of sampling points. 

You can run the algorithm clicking the 'Run algorithm' button. You should see a new dialog with three tabs: 'Parameters', 'Log' and 'Help'. In the 'Parameters' tab, select the vector map, the key field in the vector map, the table (e.g. a csv file), the key field in the table and the field in the table indicating the sampling size for each category in the key field. If you want you can save the output to a permanent file or generate a temporary file (just leave it blank). Click the 'Run' button to run the algorithm.

<img src="/images/2015-10-31-qgis-r-fig-5.jpg" alt="" title="Run the R script" >

The output sample locations must be open after finished:

<img src="/images/2015-10-31-qgis-r-fig-6.jpg" alt="" title="Output" style="width:800px">

Then click the icon to save the script. In the new window you will see that you are located at the rscripts folder (e.g., /user/.qgis2/processing/rscripts) and that the file will be saved as a 'Processing R script'. Provide a name for the file and click 'Save'. The file will be saved with a '.rsx' extension.

The algorithm can also be run in batch mode.

<img src="/images/2015-10-31-qgis-r-fig-7.jpg" alt="" title="Batch mode" >

See the video below:


Click the 'Run algorithm' button. You should a new dialog with three tabs: 'Parameters', 'Log' and 'Help'. 


<br>
<br>
**You may also be interested in:**

&#42; [Web mapping with Leaflet and R]

<a id="comments"></a>

[in this previous post]:                /blog/en/r/2015/08/11/leaflet-R.html
[Web mapping with Leaflet and R]:       /blog/en/r/2015/08/11/leaflet-R.html 

