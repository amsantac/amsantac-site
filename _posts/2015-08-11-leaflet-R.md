---
layout: post
title:  "Web mapping with Leaflet and R"
date:   2015-08-11 11:02:52
categories: blog R leaflet webmapping
---

[Leaflet] is a JavaScript library that has become quite popular for creating interactive maps. In this post I explain how to create a web map using Leaflet in the [R environment].

There are different ways to create a map using the Leaflet JS library. One way is to include the Leaflet JS and CSS files in the head of a web page and then set up the map in the body of the html page, as shown in the [Leaflet Quick Start Guide].

An alternative way is to create the web map in the R environment using an R package called [leaflet], developed by the guys from [RStudio], which allows controlling and integrating Leaflet maps in R. Here I'll show how to read a vector map in [shapefile] format and create a leaflet web map customizing how the vector map is displayed. Also I will show how to add a legend, layer controls and popups for displaying attribute data. I recommend to use the [RStudio IDE] for the purpose of this tutorial.

First we need to install the leaflet package in R entering the following command line in the R console:

```
install.packages("leaflet")
```
<br>
The next step is to read in R the maps we want to display in our web map. For reading a shapefile, there are a number of functions included in different R packages (see [rgdal], [maptools], [shapefiles], and [others]). I'm going to use the [raster] package, so we need to install it first:

```
install.packages("raster")
```
<br>
Now let's load the two packages:

```
library(raster)
 library(leaflet)
```
<br>
For this example I am going to import in R a polygon shapefile enclosing the study area of one of my projects. The projection of this map is defined in geographic coordinates (latitude/longitude). Let's use the `shapefile` function from the raster package to read the file:

```
llanos <- shapefile("C:/my_dir/llanos.shp")
```
<br>
In this case the file has been read in R as an [SpatialPolygonsDataFrame] object called `llanos`. Now we are going to create the leaflet map using this object for the `data` argument in the `leaflet` function. We can do that in just one line of code concatenating several commands with the forward pipe operator `%>%`. First we create a Leaflet map widget (with the `leaflet` command) and then add a tile layer (with `addTiles`), the vector map as polygon (`addPolygons`) and a legend (`addLegend`).

```
leaflet(data = llanos) %>% addTiles() %>% addPolygons(fill = FALSE, stroke = TRUE, color = "#03F") %>% 
  addLegend("bottomright", colors = "#03F", labels = "Llanos ecoregion")
```
<br>
The `fill`, `stroke` and `color` arguments allow customizing whether to fill the polygon with color, whether to draw the border of the polygon, and the border color, respectively. For the `addLegend` command, we define the position, colors and labels of the legend. If you are working in RStudio, you should see your map displayed in the 'Viewer' tab when you hit enter:

<img src="/images/2015-08-11-leaflet-R-fig-1.png" alt="Web map with leaflet" style="width:785px">

Leaflet displays [OpenStreetMap (OSM)] tiles by default but you can use any map provider (e.g., [MapQuest Open], [MapBox], [Bing Maps], etc.) as long as you conform to its terms of use. You can see the help page for the `addTiles` function in R, if needed, entering `?addTiles` in the R console.

We can display more than one map at a time with leaflet. For this example I am going to overlay another polygon feature that shows the [Landsat] scenes that cover my study area based on the [WRS2 descending grid]. Let's read this second shapefile: 

```
wrs2 <- shapefile("C:/my_dir/wrs2_desc.shp")
```
<br>
As before, we create the Leaflet map widget, add the OSM tiles and add the polygons. For adding layers controls, we need to provide the name of the group the newly created layers should belong to. For example, I will define "Study area" as the group for the `llanos` layer, and the "Landsat scenes" group for the `wrs2` layer. For popups, the `popup` argument in the `addPolygons` function is used to display attribute data from the vector map. In this case, I am using a column called 'PATH_ROW' that indicates the path and row of the corresponding Landsat scene. 
<br>
<br>
For the legend, we add pairs of values for the `colors` and `labels` arguments corresponding to the corresponding values for each of the map layers. Finally, the `addLayersControl` functions allows adding user interface controls to switch the layers on and off. We have to enter the name of the group each layer map belong to in the `overlayGroups` argument and then we define whether we want the layers control to be collapsed or not, using the `options` argument. The complete code snippet can be seen below:

```
leaflet() %>% addTiles() %>%   
  addPolygons(data = llanos, fill = FALSE, stroke = TRUE, color = "#03F", group = "Study area") %>% 
  addPolygons(data = wrs2, fill = TRUE, stroke = TRUE, color = "#f93", 
              popup = paste0("Scene: ", as.character(wrs2$PATH_ROW)), group = "Landsat scenes") %>% 
  # add a legend
  addLegend("bottomright", colors = c("#03F", "#f93"), labels = c("Study area", "Landsat scenes (path - row)")) %>%   
  # add layers control
  addLayersControl(
    overlayGroups = c("Study area", "Landsat scenes"),
    options = layersControlOptions(collapsed = FALSE)
  )
```
<br>
Finally export the map as an html page. In the 'Viewer' tab in RStudio, click the 'Export' button and then click 'Save as Web page...'. Then you just need to upload your output html page to your website to make your map available online. You can see an example of a map created with leaflet in this [link][web map]. 

Once uploaded, you can also embed your map in another web page inserting a code snippet like the one below wherever you want to display it: 

<div font style="BACKGROUND-COLOR:#f5f5f5;line-height:0.8">
<xmp font style="border:1px solid;border-color:#d1d1d1;black;border-radius:3px;padding: 0em 0 0.3em 0.3em">
<iframe id="map_id" width=700 height=500 src="http://mywebsite.com/my_map.html"></iframe>
</xmp>
</font></div>

Now you have a fancy web map with legend, layers controls and popups:

<iframe id="map_llanos_emb" width=785 height=500 src="http://amsantac.github.io/cuproject/www/landsat_scenes.html"></iframe>

<br>
That's it. Congratulations! 

[Leaflet]:                   http://leafletjs.com/
[RStudio]:                   https://www.rstudio.com/
[RStudio IDE]:               https://www.rstudio.com/products/rstudio/ 
[leaflet]:                   https://rstudio.github.io/leaflet/
[R environment]:             http://r-project.org
[R language]:                http://r-project.org
[rstudio_ss]:                /images/2015-08-11-leaflet-R-fig-1.png "Web map with leaflet"
[web map]:                   http://amsantac.github.io/cuproject/www/map_llanos.html
[OpenStreetMap (OSM)]:             http://www.openstreetmap.org/
[MapQuest Open]:             http://www.mapquest.com/
[MapBox]:                    https://www.mapbox.com/
[Bing Maps]:                 http://www.microsoft.com/maps/choose-your-bing-maps-API.aspx
[Leaflet Quick Start Guide]: http://leafletjs.com/examples/quick-start.html
[shapefile]:                 https://doc.arcgis.com/en/arcgis-online/reference/shapefiles.htm
[rgdal]:                     https://cran.r-project.org/package=rgdal
[maptools]:                  https://cran.r-project.org/package=maptools
[shapefiles]:                https://cran.r-project.org/package=shapefiles
[others]:                    http://gis.stackexchange.com/questions/118077/read-esri-shape-file-polygon-or-polyline-in-r-environment
[raster]:                    https://cran.r-project.org/package=raster
[SpatialPolygonsDataFrame]:  http://www.inside-r.org/packages/cran/sp/docs/as.data.frame.SpatialPolygonsDataFrame
[Landsat]:                   http://landsat.usgs.gov/
[WRS2 descending grid]:      http://landsat.usgs.gov/tools_wrs-2_shapefile.php
