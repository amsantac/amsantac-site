---
layout: post-es
title:  "IntegraciÃ³n de QGIS y R: Un ejemplo con muestreo espacial estratificado"
date:   2015-10-31 11:02:52
categories: blog es
tags: R QGIS muestreo SIG
image: 2015-10-03-qgis-r-mini.jpg
published: false
---

[QGIS], un software libre y de cÃ³digo abierto, se ha convertido en uno de los SIG (sistema de informaciÃ³n geogrÃ¡fica) lÃ?der del mercado. Gracias al trabajo de un grupo activo de desarrolladores, QGIS contiene mÃ³dulos de geoprocesamiento similares a herramientas estÃ¡ndar que se encuentran en SIG privativos. AdemÃ¡s, QGIS permite la lectura y escritura de la mayorÃ?a de formatos vector y raster, al tiempo que provee una interfaz a bases de datos como PostgreSQL/PostGIS, SpatiaLite y MySQL.

Una de las caracterÃ?sticas mÃ¡s atractivas de QGIS es su integraciÃ³n con otros paquetes estadÃ?sticos y SIG de cÃ³digo abierto. Actualmente, QGIS soporta SAGA, Orfeo Toolbox, GRASS GIS y R, lo cual expande ampliamente la funcionalidad de QGIS. En este post hago Ã©nfasis en la integraciÃ³n entre QGIS y R y explico como configurar el sistema de procesamiento de QGIS y cÃ³mo ejecutar un algoritmo externo de R desde el mÃ³dulo de procesamiento de QGIS.  

<!--more-->

<img src="/images/2015-10-31-qgis-r-fig-0.JPG" alt="" title="" style="width:750px">

### **ConfiguraciÃ³n de la aplicaciÃ³n R en QGIS**

Para ejecutar un algoritmo de R en QGIS, primero tenemos que activar R en QGIS e indicar la carpeta donde estÃ¡n localizados los archivos binarios de R. En la interfaz de QGIS, debemos ir al menÃº â€˜Processingâ€™ y luego seleccionar â€˜Options...â€™. En la ventana â€˜Processing optionsâ€™ (ver el pantallazo abajo), debemos ir a â€˜R scriptsâ€™ y marcar la casilla junto a â€˜Activateâ€™. En la opciÃ³n â€˜R folderâ€™, debemos buscar y seleccionar la carpeta donde esta instalado R en nuestro computador. TambiÃ©n fijÃ©monos en la opciÃ³n â€˜R Scripts folderâ€™; este es el folder donde serÃ¡n guardados los scripts de R. Cerramos la ventana haciendo click en â€˜Okâ€™. 

<img src="/images/2015-10-31-qgis-r-fig-1.JPG" alt="" title="ConfiguraciÃ³n de R en QGIS" style="width:500px">

Ahora abramos el panel â€˜Processing Toolboxâ€™ haciendo click en â€˜Toolboxâ€™ en el menÃº â€˜Processingâ€™ de QGIS. El panel se debe abrir en el lado derecho de la interfaz de QGIS. Notemos el menÃº desplegable en la parte inferior derecha del Processing Toolbox que indica que estamos viendo la interfaz simplificada (â€˜Simplified interfaceâ€™). Cambiemos a la interfaz avanzada (â€˜Advanced interfaceâ€™).

<img src="/images/2015-10-31-qgis-r-fig-2.JPG" alt="" title="Processing Toolbox - Interfaz avanzada" style="width:750px">

### **CÃ³mo correr un script de R en QGIS**

En el siguiente ejemplo voy a explicar cÃ³mo correr en QGIS un script de R que muestrea ubicaciones (puntos) dentro de un shapefile de multipolÃ?gonos siguiendo un muestreo aleatorio estratificado. El tamaÃ±o de muestreo es leÃ?do de una tabla (en formato csv) que indica el nÃºmero de puntos a ser creados para cada categorÃ?a de un mapa temÃ¡tico (en este caso, tipos de coberturas terrestres). El siguiente pantallazo muestra el mapa de coberturas y la tabla cargada en QGIS usando el panel â€˜Browserâ€™:

<a href="/images/2015-10-31-qgis-r-fig-3.JPG"><img src="/images/2015-10-31-qgis-r-fig-3.JPG" alt="" title="Capas cargadas" style="width:750px"></a>

Para este ejemplo necesitamos el paquete â€˜spâ€™ de R. Si este paquete no estÃ¡ instalado en tu librerÃ?a de R, te recomiendo leer [en este post anterior] cÃ³mo instalarlo.

Ahora creemos un script de R en QGIS. En el panel Processing Toolbox, vamos a â€˜R scripts' - 'Tools' y hacemos click en "Create new R script". Se despliega una nueva ventana llamada 'Script editor':

<a href="/images/2015-10-31-qgis-r-fig-4.JPG"><img src="/images/2015-10-31-qgis-r-fig-4.JPG" alt="" title="CreaciÃ³n de un script de R en QGIS" style="width:750px"></a>

Copiemos y peguemos el siguiente cÃ³digo en el editor de scripts:

```
##polyg=vector
##polyg_category_id=field polyg
##sizes_table=table
##table_category_id=field sizes_table
##sampling_size=field sizes_table
##output=output vector
library(sp)
i <- 1
category <- unique(polyg[[polyg_category_id]])[i]
categorymap <- polyg[polyg[[polyg_category_id]] == category,]
n <- sizes_table[which(sizes_table[[table_category_id]] == category), sampling_size]
spdf1 <- SpatialPointsDataFrame(spsample(categorymap, n, "random"), data = data.frame(category = rep(category, n)))

for (i in 2:length(unique(polyg[[polyg_category_id]]))){
  category <- unique(polyg[[polyg_category_id]])[i]
  categorymap <- polyg[polyg[[polyg_category_id]] == category,]
  n <- sizes_table[which(sizes_table[[table_category_id]] == category), sampling_size]
  spdf1 <- rbind(spdf1, SpatialPointsDataFrame(spsample(categorymap, n, "random"), 
                                               data = data.frame(category = rep(category, n)))
  )
}
output = spdf1

```
<br>

Las primeras seis lÃ?neas, que comienzan con doble signo de nÃºmero (##), le indican a QGIS los parÃ¡metros de entrada y de salida del algoritmo, y son usadas para crear la interfaz grÃ¡fica. Esta informaciÃ³n tambiÃ©n es usada para crear los objetos de R correspondientes que son usados posteriormente como parÃ¡metros de entrada para los comandos de R.

En este caso particular, le estamos diciendo a QGIS que definimos un parÃ¡metro llamado â€˜poligâ€™ de tipo â€˜vectorâ€™, y otro parÃ¡metro llamado 'sizes_table' de tipo 'table' (en la primera y tercer lÃ?neas, respectivamente). 'polyg_category_id' y 'table_category_id' son columnas de la tabla del mapa vectorial y de la tabla en formato .csv, respectivamente, los cuales son la columna clave (o llave primaria) que van a ser usados para emparejar las dos tablas. Para este ejemplo, esta columna clave representa un identificador Ãºnico para cada categorÃ?a (i.e., tipo de cobertura terrestre). 

DespuÃ©s de definir los parÃ¡metros de entrada se carga el paquete â€˜spâ€™, se crean las ubicaciones de los puntos de muestreo para la primera categorÃ?a, y luego se crean los puntos de muestreo para las categorÃ?as segunda hasta la Ãºltima, los cuales son unidos a los puntos creados previamente.

Para correr el algoritmo hacemos click en el botÃ³n â€˜Run algorithmâ€™ en el editor de scripts. Se abre una nueva ventana con tres pestaÃ±as: â€˜Parametersâ€™, â€˜Logâ€™ y â€˜Helpâ€™. En la pestaÃ±a â€˜ParÃ¡metrosâ€™ seleccionamos el mapa vector, la columna clave en el mapa, la tabla (e.g., un archivo .csv), la columna clave en esta tabla y la columna de la tabla que indica el tamaÃ±o de muestreo para cada categorÃ?a. Si lo deseamos podemos guardar el resultado en un archivo permanente (e.g., un shapefile) o generar un archivo temporal (simplemente dejamos en blanco el campo â€˜outputâ€™). Hacemos click en el botÃ³n â€˜Runâ€™ para ejecutar el algoritmo.

<img src="/images/2015-10-31-qgis-r-fig-5.JPG" alt="" title="Ejecutando el script de R" style="width:500px">

Las ubicaciones de muestreo resultantes se deben desplegar despuÃ©s de que finaliza la ejecuciÃ³n del algoritmo:

<img src="/images/2015-10-31-qgis-r-fig-6.JPG" alt="" title="Resultado del algoritmo" style="width:750px">

Para guardar el script de R hacemos click en el Ã?cono â€˜Saveâ€™ del editor de scripts. En la siguiente ventana observamos que estamos ubicados en el folder rscripts (e.g., C:\Users\Guest\.qgis2\processing\rscripts) y que el archivo va a ser salvado como un 'Processing R script'. Asignamos un nombre y guardamos el archivo, el cual queda salvado con extensiÃ³n â€˜.rsxâ€™.

Una vez guardado, el algoritmo tambiÃ©n puede ser ejecutado en modo de procesamiento en lotes. El script guardado lo podemos ver en el panel â€˜Processing Toolboxâ€™ dentro del grupo â€˜User R scriptsâ€™. Le damos click derecho al algoritmo y seleccionamos 'Execute as batch process'. Se abre una ventana llamada 'Batch Processing', como se muestra en el siguiente pantallazo:  

<a href="/images/2015-10-31-qgis-r-fig-7.JPG"><img src="/images/2015-10-31-qgis-r-fig-7.JPG" alt="" title="Procesamiento en lotes" style="width:750px"></a>

En la pestaÃ±a â€˜ParÃ¡metrosâ€™ debemos ingresar los parÃ¡metros de entrada del algoritmo para cada proceso. Una vez listo, hacemos click en â€˜Runâ€™.

A continuaciÃ³n puedes observar un video tutorial que presenta cÃ³mo realizar cada uno de los pasos descritos anteriormente para configurar y ejecutar un script de R en QGIS:

<iframe width="750" height="422" src="https://www.youtube.com/embed/PvS5PeTpmj8" frameborder="0" allowfullscreen></iframe>

<br>

### **Observaciones finales**

Ejecutar un algoritmo de R desde QGIS nos puede ayudar a hacer mÃ¡s eficiente el manejo y la visualizaciÃ³n de datos. Este mÃ©todo de trabajo nos evita tener que escribir lÃ?neas de cÃ³digo adicionales para importar los archivos y exportar los resultados que deberÃ¡n ser abiertos posteriormente en un SIG. AdemÃ¡s, los resultados pueden ser visualizados apenas termine la ejecuciÃ³n del script y pueden ser examinados usando las herramientas de zoom y desplazamiento en QGIS (para lo cual R es menos apropiado).

Con respecto a las desventajas, puede ser difÃ?cil depurar el cÃ³digo si se presenta un error durante la ejecuciÃ³n del script. Por lo tanto es aconsejable probar el cÃ³digo en R primero para luego correrlo en QGIS una vez el cÃ³digo estÃ© mÃ¡s o menos libre de errores.

Espero que intentes realizar anÃ¡lisis de datos espaciales usando tus scripts de R en QGIS. CuÃ©ntame cÃ³mo te va con eso!

<br>
<br>
**TambiÃ©n te puede interesar:**

&#42; [Mapeo web con Leaflet y R]

<a id="comments"></a>

[QGIS]:                                 http://www.qgis.org/
[en este post anterior]:                /blog/es/r/2015/08/11/leaflet-R-es.html
[Mapeo web con Leaflet y R]:       /blog/es/r/2015/08/11/leaflet-R-es.html 

